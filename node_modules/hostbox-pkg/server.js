const net = require('net');

const server = net.createServer(socket => {
    socket.on('data',data=>{
        const [requestHeader, ...bodyContent] = data.toString().split('\r\n\r\n');

        const [firstLine, ...otherLines] = requestHeader.split('\n');
        const [method, path, httpVersion] = firstLine.trim().split(' ');
        const headers = Object.fromEntries(otherLines.filter(_=>_)
            .map(line=>line.split(':').map(part=>part.trim()))
            .map(([name, ...rest]) => [name, rest.join(' ')]));

      
      if (method.toLowerCase() === 'get' {
        const request = {
            method, path, httpVersion, headers
        }
        console.log(request)
        
        socket.write(`HTTP/1.1 200 OK\n\n<html><head></head><body>${request.path.split('/')[1]}</body></html>`)
        socket.end((err)=>{console.log(err)})
      }
        
      if (method.toLowerCase() === 'post') {
      
        var body;
        try {
            body = JSON.parse(bodyContent);
        } catch(err){/* ignore */
          console.log(request)
          return 
        }

        console.log(request)
        const request = {
            method, path, httpVersion, headers, body
        };
        console.log(request)
        
      
        socket.write(`HTTP/1.1 200 OK\n\nhallo ${request.body.name}`)
        socket.end((err)=>{console.log(err)})
        return 
      }

      
      
    });
});

server.listen(3000);
